events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # Optimizations
    sendfile        on;
    keepalive_timeout  65;
    gzip  on;

    # Resolver for Docker DNS (prevents crash on startup if upstream missing)
    resolver 127.0.0.11 valid=30s;

    # Upstreams
    upstream auth_service { server auth-service:3001; }
    upstream chat_service { server chat-service:3002; }
    upstream interview_service { server interview-service:3003; }
    upstream code_execution_service { server code-execution-service:3004; }
    upstream quiz_service { server quiz-service:3005; }
    upstream exam_service { server exam-service:3006; }
    upstream social_service { server social-service:3007; }
    upstream math_service { server math-service:3009; }
    upstream ai_service { server ai-service:3010; }

    server {
        listen 8000;
        server_name localhost;

        # WebSocket Upgrade Handling
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;

        # 1. Auth Service
        location /api/auth {
            proxy_pass http://auth_service;
        }

        # 2. Chat Service (HTTP & Socket)
        location /api/chat {
            proxy_pass http://chat_service;
        }
        location /socket-chat {
            proxy_pass http://chat_service/socket.io/;
        }
        # Fallback default socket.io to chat-service
        location /socket.io {
            proxy_pass http://chat_service;
        }

        # 3. Quiz Service (HTTP & Socket)
        location /api/quiz {
            proxy_pass http://quiz_service;
        }
        location /socket-quiz {
            proxy_pass http://quiz_service/socket.io/;
        }

        # 4. Social Service (HTTP & Socket)
        location /api/social {
            proxy_pass http://social_service;
        }
        location /socket-social {
            proxy_pass http://social_service/socket.io/;
        }

        # 5. Interview Service
        location /api/tasks {
            proxy_pass http://interview_service;
        }

        # 6. Code Execution Service (Strip Prefix)
        location /api/code/ {
            proxy_pass http://code_execution_service/;
        }

        # 7. Exam Service
        location /api/exams {
            proxy_pass http://exam_service;
        }

        # 8. Math Service
        location /api/math {
            proxy_pass http://math_service;
        }

        # 9. AI Service
        location /api/ai {
            proxy_pass http://ai_service;
        }

        # Health Check
        location /health {
            return 200 '{"status":"ok", "service":"nginx-gateway"}';
            add_header Content-Type application/json;
        }
    }
}
